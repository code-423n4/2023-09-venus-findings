## Introduction
This analysis focuses on the Venus Prime audit hosted on Code4rena.
```
| Spec        | Value       |
| ----------- | ----------- |
| Name        | Venus Prime |
| Duration    | 6 days      |
| nSLOC       | 1039        |
```

The primary objectives of this audit are to identify potential vulnerabilities, propose mitigation strategies, and optimize gas usage within the codebase.
## Methodology
The audit process was divided into three distinct phases:
### Recon
In the Recon phase, I conducted a preliminary review of the codebase to gain a broad understanding of its structure and functionality. This initial pass allowed me to familiarize myself with the code before diving deeper. Additionally, I examined the provided documentation and gathered supplementary information from online sources and the audit's Discord channel.

### Analysis
The Analysis phase constituted the primary focus of the audit, where I conducted an in-depth examination of the codebase. My approach involved meticulously documenting suspicious code sections, identifying minor bugs, and envisioning potential attack vectors. I explored how various attack scenarios could manifest within the code and delved into the relevant functions. Throughout this phase, I maintained communication with the protocol team to verify findings and clarify any ambiguities.

### Reporting
After compiling initial notes during the Analysis phase, I refined and expanded upon these findings. I also developed test cases to complement the identified issues and integrated them into the final report. Furthermore, I generated Quality Assurance (QA) and Gas reports, alongside this comprehensive analysis.

## Overview
**Venus Prime** comprises a system where users stake a specified amount of XVS tokens in the XVS-Vault, the native token of the Venus protocol. In return, users receive a unique token, subject to specific conditions. Notably, to obtain a token, users must stake 1000 XVS tokens for a 90-day period.

Two distinct types of tokens exist within the system: "normal" revocable tokens and irrevocable tokens. The former may be revoked (burned) if a user's stake falls below 1000 XVS, whereas the latter remains immune to such revocation. Notably, these tokens do not adhere to the ERC standard and instead employ custom implementations. Furthermore, tokens are non-transferable, and each address may possess only one token at any given time.

The codebase also incorporates the **PrimeLiquidityProvider**, responsible for managing liquidity within the Prime contract. It receives tokens (interest) generated by the protocol and distributes them to the Prime contract when required.

In addition to the primary contracts mentioned above, several smaller libraries and contracts contribute to the system's functionality:

- **PrimeStorage:** An outsourced storage contract inherited by the Prime token.
- **Scores:** A library responsible for calculating user scores.
- **FixedMath0x/FixedMath:** Mathematical libraries facilitating complex mathematical operations.

The system interacts with several other contracts within the Venus protocol, with significant relevance attributed to the **protocolShareReserve** and **xvsVault**.

## Detailed Analysis
### Prime
The **Prime** token contract is the centerpiece of the system, encompassing token minting, burning, interest claiming, and APR calculation. The contract handles interest accrual and equitable distribution to users. Additionally, it maintains a record of markets designated as prime markets, each associated with an upper limit set during deployment.

**Recommendations:**

1. **Token Naming**: Consider renaming the irrevocable tokens to better align with their actual functionality, as their potential revocation contradicts their current name. As mentioned by the host, the irrevocable tokens might be revoked by the community, when a user does not use the protocol for long. Suggested alternatives include "plus tokens" or "special tokens." If retaining the name "irrevocable," remove the functionality for others to burn these tokens, preserving the trust associated with irrevocable tokens.
2. **Market Management**: Implement a mechanism allowing Governance to remove corrupted or problematic markets from the prime program. This flexibility enhances the protocol's adaptability to evolving scenarios.

### PrimeLiquidityProvider
The **PrimeLiquidityProvider** offers a second source of liquidity for the Prime contract when it runs out of tokens and must provide users with their accrued interest.

**Recommendations:**
1. **Access Control**: Simplify the codebase by replacing the Ownable functionalities with AccessControlManager (ACM) functionalities, ensuring consistency and reliability across the protocol.

### Storage, Scores & Math
- **PrimeStorage** serves as the storage setup for the Prime contract, enhancing clarity and simplifying storage examination.
- **Scores** is a library responsible for calculating user scores, particularly valuable for score calculation clarity.
- **Math libraries** offer secure mathematical operations, including exponentiation and logarithmic calculations.

## Potential attack vectors
1. **Insufficient XVS Staking**: Users may acquire tokens without staking the required amount of XVS.
2. **Premature Token Acquisition**: Users may acquire tokens before the designated 90-day staking period.
3. **Unrevoked Revocable Tokens**: Revocable tokens may not be revoked automatically after a user unstakes their XVS, potentially leading to unintended token behavior.
4. **Token Upgrade to Irrevocable**: Users might exploit vulnerabilities to upgrade their revocable tokens to irrevocable tokens, potentially undermining the token's intended functionality.
5. **Claiming Excessive Interest**: Users may exploit vulnerabilities to claim more interest than allowed.
6. **Manipulating Claimable Interest**: Malicious users may decrease the claimable interest of others.
7. **Claiming Interest Without Tokens**: Attackers may attempt to claim interest without owning a token.
8. **Protocol Locking/Frozen State**: The protocol may become locked, frozen, or face repeated out-of-gas scenarios.
9. **Malicious Governance**: Compromised Governance keys may lead to malicious actions or token draining.
## Centralization Risk
The security of the Prime functionality significantly relies on the security of Governance and the AccessControlManager (ACM). If the ACM is compromised, malicious actors could exploit functions with potentially harmful consequences. For example, an attacker could burn other users' prime tokens, issue arbitrary prime tokens, pause the protocol, or conduct Denial-of-Service (DOS) attacks.

**Recommendations on Centralization Risk:**
Mitigate this risk by safeguarding the ACM against any compromise or unauthorized access. Ensuring the ACM's integrity is paramount to prevent the exploitation of functions that could disrupt the protocol.
## Code Quality
The codebase exhibits a high level of code quality. It is well-documented and adheres to best practices, encompassing custom errors/events, interfaces, and parameter checks. Variables and functions mostly comply with Solidity Style Guide standards. Moreover, the code maintains simplicity and organization, utilizing separate contracts for distinct functionalities.

## Test Suite
The test suite consists of two files, one for the Prime token and another for the PrimeLiquidityProvider. It leverages the Hardhat framework and incorporates libraries such as `smock`, `hardhat-network-helpers`, `chai`, `ethers`, and `typechain`. Proxy and initialization occur in a single transaction, reducing front-running risk.

**Recommendations on Test Suite:**
Some of the functions are not tested fully. Examples are:
- `Prime.updateMultipliers()` is not tested at all
- `Prime.setLimit()` is only used in the setup but never tested
- `Prime.getPendingInterests()` return values are never tested
- `Prime.togglePause()` is never tested (pausing functionality is essential and should definitely be tested)
- `Prime.claimTimeRemaining()` is not tested for edge cases (user has not deposited enough/anything)
- `PrimeLiquidityProvider.getEffectiveDistributionSpeed()` is not tested
- `PrimeLiquidityProvider.sweepToken()` is not tested for access by someone else than the owner
It is recommended to add additional tests for these functions to verify their correct functionality.

The access control manager always returns true if someone wants to access a function, so there is no testing to verify that a function reverts in the case of the caller not being allowed to access it. It is recommended to add testcases in which the ACM returns false for certain addresses.

Additionally the test suite is lacking tests in which multiple functionalities get combined to check for cross reactions, especially for the prime contract. It is recommended to add more cross functionality tests, as well as bigger testcases simulating multiple users staking/unstaking XVS as well as retrieving funds.

## Comments, Documentation
The codebase features helpful comments that aid in understanding its functionality, making it accessible to new developers. NatSpec is employed to provide standardized descriptions, adhering to the Solidity Style Guide. However, adherence to NatSpec standards could be improved in some areas, as inconsistencies occasionally arise.

**Recommendations on Comments and Documentation:**
Offer additional explanations for functions responsible for updating Scores and accruing interest, as these are critical but may not be entirely clear from existing comments. Enhanced clarity in these areas would benefit future developers working on the code.

## Conclusions
The audit spanned a full six days and comprised three phases:

- Days 1-2: Documentation review, initial code inspection, and gaining an understanding of the system's functionalities.
- Days 3-5: In-depth code analysis, vulnerability identification, and bug hunting.
- Day 6: Reporting findings, including bug reports and this comprehensive analysis.

Total time spent: 40 hours.


### Time spent:
40 hours